name: Run unit tests

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'app/**'
      - 'bootstrap/**'
      - 'config/**'
      - 'database/**'
      - 'public/**'
      - 'resources/**'
      - 'routes/**'
      - 'storage/**'
      - 'style-guide/**'
      - 'tests/**'

jobs:
  tests:
    runs-on: ubuntu-latest
    container: lorisleiva/laravel-docker:8.1
    steps:
      - uses: actions/checkout@v2
      - name: install dependencies
        run: |
          composer install
      - name: start docker containers
        run: |
          cp .env.docker .env
          docker-compose -f docker-compose.yml up --build -d
      - name: give time for database to become available
        run: |
          SLEEP_DURATION=10
          echo "Sleeping for $SLEEP_DURATION seconds..."
          sleep $SLEEP_DURATION
      - name: migrate database
        run: |
          docker exec "hackgreenville" /bin/bash -c "php artisan migrate --seed"
      - name: run tests
        run: |
          docker exec "hackgreenville" /bin/bash -c "php artisan test"
